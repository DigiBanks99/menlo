# Menlo Production Docker Compose Configuration
# Optimized for Windows 10 + Podman + Ollama setup

version: '3.8'

services:
  menlo-api:
    image: ghcr.io/digibanks99/menlo/menlo-api:latest
    container_name: menlo-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=${POSTGRES_DB:-menlo};Username=${POSTGRES_USER:-menlo};Password=${POSTGRES_PASSWORD}
      - Ollama__BaseUrl=http://ollama:11434
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - Logging__LogLevel__Microsoft.SemanticKernel=Information
    ports:
      - "8080:8080"
    networks:
      - menlo-network
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      - menlo_logs:/app/logs

  postgres:
    image: postgres:17
    container_name: menlo-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-menlo}
      - POSTGRES_USER=${POSTGRES_USER:-menlo}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backups:/var/backups/postgresql
    ports:
      - "5432:5432"
    networks:
      - menlo-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-menlo} -d ${POSTGRES_DB:-menlo}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  ollama:
    image: ollama/ollama:latest
    container_name: menlo-ollama
    restart: unless-stopped
    environment:
      # Keep models in memory longer for better performance
      - OLLAMA_KEEP_ALIVE=24h
      # Allow parallel requests for better throughput
      - OLLAMA_NUM_PARALLEL=2
      # Configure memory usage
      - OLLAMA_MAX_LOADED_MODELS=3
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - menlo-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:11434/api/tags || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 180s  # Give more time for initial model downloads

volumes:
  # Persistent data volumes
  postgres_data:
    name: menlo_postgres_data
    driver: local

  postgres_backups:
    name: menlo_postgres_backups
    driver: local

  ollama_data:
    name: menlo_ollama_data
    driver: local

  menlo_logs:
    name: menlo_logs
    driver: local

networks:
  menlo-network:
    name: menlo_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Configuration notes:
#
# Environment Variables:
# - POSTGRES_USER: Database username (default: menlo)
# - POSTGRES_PASSWORD: Database password (REQUIRED)
# - POSTGRES_DB: Database name (default: menlo)
#
# Model Management:
# After first startup, download required models:
# podman exec menlo-ollama ollama pull phi4-mini
# podman exec menlo-ollama ollama pull phi4-vision
#
# For development/testing with smaller models:
# podman exec menlo-ollama ollama pull phi3.5:3.8b
# podman exec menlo-ollama ollama pull llava:latest
#
# Volume Locations (Podman):
# - postgres_data: ~/.local/share/containers/storage/volumes/menlo_postgres_data
# - ollama_data: ~/.local/share/containers/storage/volumes/menlo_ollama_data
# - menlo_logs: ~/.local/share/containers/storage/volumes/menlo_logs