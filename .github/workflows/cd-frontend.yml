name: CD - Deploy Frontend to Azure Static Web Apps

on:
  push:
    branches: [ main ]
    paths:
      - 'src/ui/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/cd-frontend.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '22.18.0'
  AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}

jobs:
  validate-secrets:
    name: Validate Deployment Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [[ -z "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]]; then
            echo "âŒ AZURE_STATIC_WEB_APPS_API_TOKEN secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

  build-and-deploy:
    name: Build and Deploy Angular PWA
    runs-on: ubuntu-latest
    needs: validate-secrets
    environment:
      name: 'Production'
      url: ${{ vars.FRONTEND_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.7.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies (root)
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (UI)
        working-directory: src/ui/web
        run: pnpm install --frozen-lockfile

      - name: Build Angular applications
        working-directory: src/ui/web
        run: pnpm run build:all:prod
        env:
          NODE_ENV: production
          # Add environment-specific variables here
          MENLO_API_BASE_URL: ${{ vars.API_BASE_URL || 'https://api.menlo.boshoff.dev' }}
          MENLO_APP_VERSION: ${{ github.sha }}
          MENLO_BUILD_TIMESTAMP: ${{ github.run_number }}

      - name: Test production build
        working-directory: src/ui/web
        run: |
          # Verify the main app was built
          if [ ! -d "dist/menlo-app" ]; then
            echo "âŒ Main app build output not found"
            exit 1
          fi

          # Verify key files exist
          if [ ! -f "dist/menlo-app/index.html" ]; then
            echo "âŒ index.html not found in build output"
            exit 1
          fi

          echo "âœ… Production build verification passed"

          # Display build output structure
          echo "Build output structure:"
          find dist -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -20

      - name: Generate Static Web App configuration
        run: |
          mkdir -p src/ui/web/dist/menlo-app
          cat > src/ui/web/dist/menlo-app/staticwebapp.config.json << 'EOF'
          {
            "navigationFallback": {
              "rewrite": "/index.html",
              "exclude": ["/assets/*", "/*.{css,scss,sass,js,ts,json,png,jpg,jpeg,gif,ico,svg,woff,woff2,ttf,eot}"]
            },
            "mimeTypes": {
              ".json": "application/json",
              ".woff": "application/font-woff",
              ".woff2": "application/font-woff2"
            },
            "globalHeaders": {
              "Cache-Control": "no-cache"
            },
            "routes": [
              {
                "route": "/api/*",
                "rewrite": "${{ vars.API_BASE_URL || 'https://api.menlo.boshoff.dev' }}/api/{*}"
              },
              {
                "route": "/health",
                "rewrite": "${{ vars.API_BASE_URL || 'https://api.menlo.boshoff.dev' }}/health"
              }
            ],
            "responseOverrides": {
              "404": {
                "rewrite": "/index.html",
                "statusCode": 200
              }
            }
          }
          EOF

      - name: Deploy to Azure Static Web Apps
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ env.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/ui/web/dist/menlo-app'
          api_location: ''
          output_location: ''
          skip_app_build: true
          skip_api_build: true

      - name: Verify deployment
        run: |
          echo "Deployment completed successfully"
          echo "ðŸš€ Frontend deployed to: ${{ vars.FRONTEND_URL }}"

          # Wait a moment for deployment to be ready
          sleep 30

          # Basic health check (if health endpoint exists)
          if [[ -n "${{ vars.FRONTEND_URL }}" ]]; then
            curl -f "${{ vars.FRONTEND_URL }}" -o /dev/null -s || echo "âš ï¸ Health check failed - this may be normal for a new deployment"
          fi

      - name: Post-deployment tasks
        run: |
          echo "### ðŸš€ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ vars.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY

  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()

    steps:
      - name: Notification on failure
        run: |
          echo "âŒ Frontend deployment failed"
          echo "Check the logs above for details"
          echo "Manual rollback may be required if this was a production deployment"

  storybook-deploy:
    name: Deploy Storybook Documentation
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()
    environment:
      name: 'Storybook'
      url: ${{ vars.STORYBOOK_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.7.0

      - name: Install dependencies
        working-directory: src/ui/web
        run: pnpm install --frozen-lockfile

      - name: Build Storybook (App)
        working-directory: src/ui/web
        run: pnpm run build-storybook

      - name: Build Storybook (Lib)
        working-directory: src/ui/web
        run: pnpm run build-storybook:lib

      - name: Deploy Storybook to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: vars.DEPLOY_STORYBOOK == 'true'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./src/ui/web/storybook-static
          destination_dir: storybook

      - name: Storybook deployment summary
        run: |
          echo "### ðŸ“š Storybook Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ vars.DEPLOY_STORYBOOK }}" == "true" ]]; then
            echo "- **Status**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
            echo "- **URL**: ${{ vars.STORYBOOK_URL }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: â­ï¸ Skipped (DEPLOY_STORYBOOK not enabled)" >> $GITHUB_STEP_SUMMARY
          fi