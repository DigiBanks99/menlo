name: Dependency Updates

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  update-dotnet-dependencies:
    name: Update .NET Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dotnet tools
        run: dotnet tool restore

      - name: Verify dotnet outdated tool
        run: |
          echo "Verifying dotnet outdated tool installation..."
          dotnet tool list
          echo "Testing dotnet outdated help..."
          dotnet outdated --help | head -10

      - name: Check for outdated packages
        id: outdated
        run: |
          # Run dotnet outdated with JSON output and capture both stdout and stderr
          set +e  # Don't fail immediately on error
          outdated_output=$(dotnet outdated --allow-roll-forward --output json 2>&1)
          outdated_exit_code=$?
          set -e  # Re-enable fail on error
          
          echo "Dotnet outdated output:"
          echo "$outdated_output"
          echo "Exit code: $outdated_exit_code"
          
          # Check if the output is valid JSON and contains outdated packages
          has_updates=false
          
          # First, check if we have valid JSON output
          if echo "$outdated_output" | jq empty > /dev/null 2>&1; then
            echo "Valid JSON output detected"
            # Check if there are any projects with outdated packages
            project_count=$(echo "$outdated_output" | jq '.Projects | length' 2>/dev/null || echo "0")
            if [ "$project_count" -gt 0 ]; then
              # Check if any project has outdated packages
              outdated_count=$(echo "$outdated_output" | jq '[.Projects[].PackageUpdates | length] | add' 2>/dev/null || echo "0")
              if [ "$outdated_count" -gt 0 ]; then
                has_updates=true
                echo "Found $outdated_count outdated packages across $project_count projects"
              fi
            fi
          else
            echo "Output is not valid JSON, checking for text-based indicators"
            # Fallback: check for text indicators of outdated packages
            if echo "$outdated_output" | grep -i "upgrade" > /dev/null 2>&1; then
              has_updates=true
              echo "Found text indicators of outdated packages"
            fi
          fi
          
          echo "has_updates=$has_updates" >> $GITHUB_OUTPUT
          
          # Store the output for debugging (escape newlines and quotes)
          escaped_output=$(echo "$outdated_output" | jq -R -s . || echo "\"$outdated_output\"" | sed 's/"/\\"/g')
          echo "outdated_packages=$escaped_output" >> $GITHUB_OUTPUT

      - name: Update packages
        if: steps.outdated.outputs.has_updates == 'true'
        run: |
          echo "Updating outdated packages..."
          
          # Update packages (excluding major version changes for stability)
          # Use text output for better visibility during updates
          dotnet outdated --upgrade --version-lock Major --exclude-prerelease --output Default
          
          # Restore and build to ensure updates are compatible
          echo "Restoring packages..."
          dotnet restore
          
          echo "Building solution..."
          dotnet build --no-restore

      - name: Check what was updated
        if: steps.outdated.outputs.has_updates == 'true'
        id: updates_summary
        run: |
          # Check git status to see what files were changed
          echo "Files changed during update:"
          git status --porcelain
          
          echo "Package file changes:"
          git diff --name-only | grep -E '\.(csproj|props)$' || echo "No package files changed"
          
          # Get a summary of the changes for the PR
          changes_summary=$(git diff --name-only | grep -E '\.(csproj|props)$' | head -10 | paste -sd, -)
          echo "changes_summary=$changes_summary" >> $GITHUB_OUTPUT

      - name: Run tests after updates
        if: steps.outdated.outputs.has_updates == 'true'
        run: |
          dotnet test --no-build --verbosity normal

      - name: Create Pull Request
        if: steps.outdated.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update .NET dependencies'
          title: 'chore: Update .NET Dependencies'
          body: |
            ## üì¶ Dependency Updates

            This PR contains automated updates to .NET dependencies.

            ### Files Modified
            ${{ steps.updates_summary.outputs.changes_summary }}

            ### Outdated Packages Analysis
            <details>
            <summary>Click to view outdated packages report</summary>
            
            ```
            ${{ steps.outdated.outputs.outdated_packages }}
            ```
            </details>

            ### Changes
            - Updated NuGet packages to latest minor/patch versions
            - Excluded major version updates for stability
            - All tests pass with updated dependencies

            ### Verification
            - ‚úÖ Solution builds successfully
            - ‚úÖ All tests pass
            - ‚úÖ No major version changes included

            ### Review Notes
            Please review the changes and ensure all functionality works as expected before merging.
          branch: chore/update-dotnet-dependencies
          delete-branch: true
          base: main

  check-frontend-updates:
    name: Check Frontend Dependencies
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.outdated-frontend.outputs.has_updates }}
      updates_summary: ${{ steps.outdated-frontend.outputs.updates_summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        working-directory: src/ui/web
        run: pnpm install --frozen-lockfile

      - name: Verify pnpm outdated functionality
        working-directory: src/ui/web
        run: |
          echo "Verifying pnpm outdated functionality..."
          pnpm --version
          echo "Testing pnpm outdated help..."
          pnpm outdated --help | head -10

      - name: Check for outdated packages
        id: outdated-frontend
        working-directory: src/ui/web
        run: |
          # Check for outdated packages with robust error handling
          set +e  # Don't fail immediately on error
          outdated_output=$(pnpm outdated --format json 2>&1)
          outdated_exit_code=$?
          set -e  # Re-enable fail on error
          
          echo "PNPM outdated output:"
          echo "$outdated_output"
          echo "Exit code: $outdated_exit_code"
          
          # Check if we have updates available
          has_updates=false
          
          # First, check if we have valid JSON output
          if echo "$outdated_output" | jq empty > /dev/null 2>&1; then
            echo "Valid JSON output detected"
            # Check if there are any outdated packages (JSON object with package keys)
            package_count=$(echo "$outdated_output" | jq 'keys | length' 2>/dev/null || echo "0")
            if [ "$package_count" -gt 0 ]; then
              has_updates=true
              echo "Found $package_count outdated packages"
            fi
          else
            echo "Output is not valid JSON, checking for text-based indicators"
            # Fallback: check for text indicators of outdated packages
            if echo "$outdated_output" | grep -E "(Current|Wanted|Latest)" > /dev/null 2>&1; then
              has_updates=true
              echo "Found text indicators of outdated packages"
            fi
          fi
          
          echo "has_updates=$has_updates" >> $GITHUB_OUTPUT
          
          # Store the output for debugging (escape properly for GitHub Actions)
          if [ ${#outdated_output} -lt 1000 ]; then
            # For smaller outputs, try to store as JSON string
            escaped_output=$(echo "$outdated_output" | jq -R -s . 2>/dev/null || echo "\"Error: Could not parse output\"")
          else
            # For larger outputs, truncate and store as plain string
            truncated_output=$(echo "$outdated_output" | head -20 | tail -10)
            escaped_output=$(echo "\"Output too large, showing sample: $truncated_output\"")
          fi
          echo "outdated_packages=$escaped_output" >> $GITHUB_OUTPUT

      - name: Update dependencies
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        working-directory: src/ui/web
        run: |
          echo "Updating frontend dependencies..."
          
          # Update dependencies (excluding major versions)
          echo "Running pnpm update..."
          pnpm update --latest --save-exact

          # Install updated dependencies
          echo "Installing updated dependencies..."
          pnpm install

      - name: Check what was updated
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        id: frontend-updates-summary
        working-directory: src/ui/web
        run: |
          # Check git status to see what files were changed
          echo "Files changed during update:"
          git status --porcelain
          
          echo "Package file changes:"
          git diff --name-only | grep -E 'package\.json$' || echo "No package.json files changed"
          
          # Get a summary of the changes for the PR
          changes_summary=$(git diff --name-only | grep -E 'package\.json$' | head -10 | paste -sd, -)
          echo "frontend_changes_summary=$changes_summary" >> $GITHUB_OUTPUT
          
          # Get diff summary of package.json changes
          if git diff --name-only | grep -q 'package\.json'; then
            package_diff=$(git diff package.json | grep '^[+-]' | head -10 | paste -sd$'\n' -)
            echo "Package.json changes preview:"
            echo "$package_diff"
          fi

      - name: Build and test after updates
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        working-directory: src/ui/web
        run: |
          # Build all projects
          pnpm run build:all:prod

          # Run tests
          pnpm run test:all

          # Lint code
          pnpm run lint

      - name: Create Pull Request
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update frontend dependencies'
          title: 'chore: Update Frontend Dependencies'
          body: |
            ## üì¶ Frontend Dependency Updates

            This PR contains automated updates to frontend dependencies.

            ### Files Modified
            ${{ steps.frontend-updates-summary.outputs.frontend_changes_summary }}

            ### Outdated Packages Analysis
            <details>
            <summary>Click to view outdated packages report</summary>
            
            ```
            ${{ steps.outdated-frontend.outputs.outdated_packages }}
            ```
            </details>

            ### Changes
            - Updated npm packages to latest compatible versions
            - Excluded major version updates for stability
            - All builds and tests pass with updated dependencies

            ### Verification
            - ‚úÖ All projects build successfully
            - ‚úÖ All tests pass
            - ‚úÖ Linting passes
            - ‚úÖ No major version changes included

            ### Review Notes
            Please review the changes and test the application thoroughly before merging.
          branch: chore/update-frontend-dependencies
          delete-branch: true
          base: main

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Audit .NET packages
        run: |
          dotnet restore
          dotnet list package --vulnerable --include-transitive > dotnet-audit.txt || true

          if grep -q "vulnerable" dotnet-audit.txt; then
            echo "‚ö†Ô∏è Vulnerable .NET packages found"
            cat dotnet-audit.txt
          else
            echo "‚úÖ No vulnerable .NET packages found"
          fi

      - name: Audit frontend packages
        working-directory: src/ui/web
        run: |
          pnpm install --frozen-lockfile
          pnpm audit --audit-level moderate > ../../../frontend-audit.txt || true

          if grep -q "vulnerabilities" ../../../frontend-audit.txt; then
            echo "‚ö†Ô∏è Vulnerable frontend packages found"
            cat ../../../frontend-audit.txt
          else
            echo "‚úÖ No vulnerable frontend packages found"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            dotnet-audit.txt
            frontend-audit.txt

      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = '## üö® Security Vulnerabilities Detected\n\n';
            body += 'Automated security audit has detected vulnerable dependencies.\n\n';

            try {
              const dotnetAudit = fs.readFileSync('dotnet-audit.txt', 'utf8');
              if (dotnetAudit.includes('vulnerable')) {
                body += '### .NET Dependencies\n```\n' + dotnetAudit + '\n```\n\n';
              }
            } catch (e) {
              console.log('No .NET audit file found');
            }

            try {
              const frontendAudit = fs.readFileSync('frontend-audit.txt', 'utf8');
              if (frontendAudit.includes('vulnerabilities')) {
                body += '### Frontend Dependencies\n```\n' + frontendAudit + '\n```\n\n';
              }
            } catch (e) {
              console.log('No frontend audit file found');
            }

            body += '### Action Required\n';
            body += '- Review the vulnerable packages listed above\n';
            body += '- Update to secure versions where available\n';
            body += '- Consider alternative packages if updates are not available\n';
            body += '- Run `dotnet restore` and `pnpm audit fix` to attempt automatic fixes\n';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Security Vulnerabilities Detected',
              body: body,
              labels: ['security', 'dependencies', 'bug']
            });