name: Dependency Updates

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  update-dotnet-dependencies:
    name: Update .NET Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install dotnet outdated tool
        run: dotnet tool install --global dotnet-outdated-tool

      - name: Check for outdated packages
        id: outdated
        run: |
          outdated_output=$(dotnet outdated --output json)
          echo "outdated_packages=$outdated_output" >> $GITHUB_OUTPUT

          # Check if there are any outdated packages
          if echo "$outdated_output" | jq -e '.Projects | length > 0' > /dev/null; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Update packages
        if: steps.outdated.outputs.has_updates == 'true'
        run: |
          # Update packages (excluding major version changes for stability)
          dotnet outdated --upgrade --version-lock Major --exclude-prerelease

          # Restore and build to ensure updates are compatible
          dotnet restore
          dotnet build --no-restore

      - name: Run tests after updates
        if: steps.outdated.outputs.has_updates == 'true'
        run: |
          dotnet test --no-build --verbosity normal

      - name: Create Pull Request
        if: steps.outdated.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update .NET dependencies'
          title: 'chore: Update .NET Dependencies'
          body: |
            ## üì¶ Dependency Updates

            This PR contains automated updates to .NET dependencies.

            ### Changes
            - Updated NuGet packages to latest minor/patch versions
            - Excluded major version updates for stability
            - All tests pass with updated dependencies

            ### Verification
            - ‚úÖ Solution builds successfully
            - ‚úÖ All tests pass
            - ‚úÖ No major version changes included

            ### Review Notes
            Please review the changes and ensure all functionality works as expected before merging.
          branch: chore/update-dotnet-dependencies
          delete-branch: true
          base: main

  check-frontend-updates:
    name: Check Frontend Dependencies
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.outdated-frontend.outputs.has_updates }}
      updates_summary: ${{ steps.outdated-frontend.outputs.updates_summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        working-directory: src/ui/web
        run: pnpm install --frozen-lockfile

      - name: Check for outdated packages
        id: outdated-frontend
        working-directory: src/ui/web
        run: |
          # Check for outdated packages
          outdated_output=$(pnpm outdated --format json || echo '{}')
          echo "outdated_packages=$outdated_output" >> $GITHUB_OUTPUT

          # Check if there are updates available
          if [ "$outdated_output" != "{}" ] && [ "$outdated_output" != "" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Update dependencies
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        working-directory: src/ui/web
        run: |
          # Update dependencies (excluding major versions)
          pnpm update --latest --save-exact

          # Install updated dependencies
          pnpm install

      - name: Build and test after updates
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        working-directory: src/ui/web
        run: |
          # Build all projects
          pnpm run build:all:prod

          # Run tests
          pnpm run test:all

          # Lint code
          pnpm run lint

      - name: Create Pull Request
        if: steps.outdated-frontend.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update frontend dependencies'
          title: 'chore: Update Frontend Dependencies'
          body: |
            ## üì¶ Frontend Dependency Updates

            This PR contains automated updates to frontend dependencies.

            ### Changes
            - Updated npm packages to latest compatible versions
            - Excluded major version updates for stability
            - All builds and tests pass with updated dependencies

            ### Verification
            - ‚úÖ All projects build successfully
            - ‚úÖ All tests pass
            - ‚úÖ Linting passes
            - ‚úÖ No major version changes included

            ### Review Notes
            Please review the changes and test the application thoroughly before merging.
          branch: chore/update-frontend-dependencies
          delete-branch: true
          base: main

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Audit .NET packages
        run: |
          dotnet restore
          dotnet list package --vulnerable --include-transitive > dotnet-audit.txt || true

          if grep -q "vulnerable" dotnet-audit.txt; then
            echo "‚ö†Ô∏è Vulnerable .NET packages found"
            cat dotnet-audit.txt
          else
            echo "‚úÖ No vulnerable .NET packages found"
          fi

      - name: Audit frontend packages
        working-directory: src/ui/web
        run: |
          pnpm install --frozen-lockfile
          pnpm audit --audit-level moderate > ../../../frontend-audit.txt || true

          if grep -q "vulnerabilities" ../../../frontend-audit.txt; then
            echo "‚ö†Ô∏è Vulnerable frontend packages found"
            cat ../../../frontend-audit.txt
          else
            echo "‚úÖ No vulnerable frontend packages found"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            dotnet-audit.txt
            frontend-audit.txt

      - name: Create issue for vulnerabilities
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = '## üö® Security Vulnerabilities Detected\n\n';
            body += 'Automated security audit has detected vulnerable dependencies.\n\n';

            try {
              const dotnetAudit = fs.readFileSync('dotnet-audit.txt', 'utf8');
              if (dotnetAudit.includes('vulnerable')) {
                body += '### .NET Dependencies\n```\n' + dotnetAudit + '\n```\n\n';
              }
            } catch (e) {
              console.log('No .NET audit file found');
            }

            try {
              const frontendAudit = fs.readFileSync('frontend-audit.txt', 'utf8');
              if (frontendAudit.includes('vulnerabilities')) {
                body += '### Frontend Dependencies\n```\n' + frontendAudit + '\n```\n\n';
              }
            } catch (e) {
              console.log('No frontend audit file found');
            }

            body += '### Action Required\n';
            body += '- Review the vulnerable packages listed above\n';
            body += '- Update to secure versions where available\n';
            body += '- Consider alternative packages if updates are not available\n';
            body += '- Run `dotnet restore` and `pnpm audit fix` to attempt automatic fixes\n';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Security Vulnerabilities Detected',
              body: body,
              labels: ['security', 'dependencies', 'bug']
            });