name: CD - Deploy Backend (Windows 10 + Podman)

on:
  push:
    branches: [ main ]
    paths:
      - 'src/api/**'
      - 'src/lib/**'
      - 'Menlo.slnx'
      - 'Directory.Build.props'
      - 'Directory.Packages.props'
      - '.github/workflows/cd-backend.yml'
      - 'Dockerfile'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/menlo-api

jobs:
  build-and-push:
    name: Build and Push Container
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-to-home-server:
    name: Deploy to Home Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: 'Production'

    steps:
      - name: Checkout deployment scripts
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            deployment/

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HOME_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOME_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy application
        run: |
          # Create deployment script
          cat > deploy-remote.ps1 << 'EOF'
          $ErrorActionPreference = "Stop"

          Write-Host "üöÄ Starting Menlo deployment..." -ForegroundColor Green

          # Set environment variables
          $env:POSTGRES_USER = "${{ secrets.POSTGRES_USER }}"
          $env:POSTGRES_PASSWORD = "${{ secrets.POSTGRES_PASSWORD }}"
          $env:POSTGRES_DB = "menlo"

          # Application paths
          $AppPath = "$env:USERPROFILE\menlo"
          New-Item -ItemType Directory -Path $AppPath -Force | Out-Null
          Set-Location $AppPath

          # Create docker-compose.prod.yml
          $composeContent = @"
          version: '3.8'

          services:
            menlo-api:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
              container_name: menlo-api
              restart: unless-stopped
              environment:
                - ASPNETCORE_ENVIRONMENT=Production
                - ASPNETCORE_URLS=http://+:8080
                - ConnectionStrings__DefaultConnection=Host=postgres;Database=menlo;Username=$env:POSTGRES_USER;Password=$env:POSTGRES_PASSWORD
                - Ollama__BaseUrl=http://ollama:11434
                - Logging__LogLevel__Default=Information
              ports:
                - "8080:8080"
              networks:
                - menlo-network
              depends_on:
                - postgres
                - ollama
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s

            postgres:
              image: postgres:17
              container_name: menlo-postgres
              restart: unless-stopped
              environment:
                - POSTGRES_DB=menlo
                - POSTGRES_USER=$env:POSTGRES_USER
                - POSTGRES_PASSWORD=$env:POSTGRES_PASSWORD
              volumes:
                - postgres_data:/var/lib/postgresql/data
              ports:
                - "5432:5432"
              networks:
                - menlo-network
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U $env:POSTGRES_USER -d menlo"]
                interval: 30s
                timeout: 10s
                retries: 5

            ollama:
              image: ollama/ollama:latest
              container_name: menlo-ollama
              restart: unless-stopped
              volumes:
                - ollama_data:/root/.ollama
              ports:
                - "11434:11434"
              networks:
                - menlo-network
              environment:
                - OLLAMA_KEEP_ALIVE=24h
                - OLLAMA_NUM_PARALLEL=2
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:11434/api/tags || exit 1"]
                interval: 60s
                timeout: 30s
                retries: 3
                start_period: 120s

          volumes:
            postgres_data:
              name: menlo_postgres_data
            ollama_data:
              name: menlo_ollama_data

          networks:
            menlo-network:
              name: menlo_network
              driver: bridge
          "@

          $composeContent | Out-File -FilePath "docker-compose.prod.yml" -Encoding UTF8

          # Pull new image
          Write-Host "üì• Pulling new image..." -ForegroundColor Yellow
          podman pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

          # Stop existing services
          Write-Host "‚è∏Ô∏è Stopping existing services..." -ForegroundColor Yellow
          podman-compose -f docker-compose.prod.yml down 2>$null

          # Start services
          Write-Host "‚ñ∂Ô∏è Starting services..." -ForegroundColor Yellow
          podman-compose -f docker-compose.prod.yml up -d

          # Wait for health checks
          Write-Host "üè• Waiting for services..." -ForegroundColor Yellow
          Start-Sleep -Seconds 30

          # Check service status
          Write-Host "üìä Service Status:" -ForegroundColor Cyan
          podman-compose -f docker-compose.prod.yml ps

          Write-Host "‚úÖ Deployment completed!" -ForegroundColor Green
          EOF

          # Execute deployment
          scp -i ~/.ssh/id_rsa deploy-remote.ps1 ${{ secrets.HOME_SERVER_USER }}@${{ secrets.HOME_SERVER_HOST }}:~/deploy-remote.ps1
          ssh -i ~/.ssh/id_rsa ${{ secrets.HOME_SERVER_USER }}@${{ secrets.HOME_SERVER_HOST }} "powershell -ExecutionPolicy Bypass -File ~/deploy-remote.ps1"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          sleep 30

          # Check if API is responding
          ssh -i ~/.ssh/id_rsa ${{ secrets.HOME_SERVER_USER }}@${{ secrets.HOME_SERVER_HOST }} << 'EOF'
            # Test API health
            for i in {1..5}; do
              if powershell -Command "try { Invoke-WebRequest -Uri 'http://localhost:8080/health' -TimeoutSec 5 -UseBasicParsing | Select-Object -ExpandProperty StatusCode } catch { 0 }" | grep -q "200"; then
                echo "‚úÖ API health check passed"
                break
              else
                echo "‚è≥ API not ready yet... ($i/5)"
                sleep 10
              fi
            done
          EOF

      - name: Update Cloudflare Tunnel
        if: vars.CLOUDFLARE_TUNNEL_ENABLED == 'true'
        run: |
          echo "üåê Restarting Cloudflare Tunnel..."
          ssh -i ~/.ssh/id_rsa ${{ secrets.HOME_SERVER_USER }}@${{ secrets.HOME_SERVER_HOST }} << 'EOF'
            # Restart cloudflared service if running
            if (Get-Service cloudflared -ErrorAction SilentlyContinue) {
              Restart-Service cloudflared
              Write-Host "Cloudflare Tunnel restarted"
            } else {
              Write-Host "Cloudflare Tunnel service not found"
            }
          EOF

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          ssh-keygen -R ${{ secrets.HOME_SERVER_HOST }} 2>/dev/null || true

  post-deployment:
    name: Post-Deployment Checks
    runs-on: ubuntu-latest
    needs: deploy-to-home-server
    if: success()

    steps:
      - name: External health check
        run: |
          echo "üè• Running external health check..."

          if [[ -n "${{ vars.DOMAIN }}" && -n "${{ vars.SUBDOMAIN }}" ]]; then
            API_URL="https://${{ vars.SUBDOMAIN }}.${{ vars.DOMAIN }}"

            # Wait for Cloudflare tunnel to stabilize
            sleep 60

            # Check external API health
            for i in {1..3}; do
              if curl -f "$API_URL/health" -H "User-Agent: GitHub-Actions-Health-Check" -s; then
                echo "‚úÖ External API health check passed for $API_URL"
                break
              else
                echo "‚è≥ External API at $API_URL not ready yet... ($i/3)"
                sleep 30
              fi
            done
          elif [[ -n "${{ vars.API_BASE_URL }}" ]]; then
            # Fallback to legacy API_BASE_URL variable
            sleep 60

            # Check external API health
            for i in {1..3}; do
              if curl -f "${{ vars.API_BASE_URL }}/health" -H "User-Agent: GitHub-Actions-Health-Check" -s; then
                echo "‚úÖ External API health check passed"
                break
              else
                echo "‚è≥ External API not ready yet... ($i/3)"
                sleep 30
              fi
            done
          else
            echo "‚ö†Ô∏è Domain variables (DOMAIN, SUBDOMAIN) or API_BASE_URL not configured, skipping external health check"
          fi

      - name: Deployment summary
        run: |
          echo "### üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Home" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: ${{ secrets.HOME_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY

          if [[ -n "${{ vars.DOMAIN }}" && -n "${{ vars.SUBDOMAIN }}" ]]; then
            echo "- **External URL**: https://${{ vars.SUBDOMAIN }}.${{ vars.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          elif [[ -n "${{ vars.API_BASE_URL }}" ]]; then
            echo "- **External URL**: ${{ vars.API_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
          fi